name: LineageOS GSI Build and Upload

on:
  # Manual trigger only - no automatic builds to save GitHub Actions minutes
  workflow_dispatch:
    inputs:
      build_targets:
        description: 'Build targets (e.g., A64VN A64GN 64VN 64GN)'
        required: true
        default: 'A64VN A64GN 64VN 64GN'
        type: string
      upload_to_telegram:
        description: 'Upload to Telegram'
        required: true
        default: true
        type: boolean

env:
  BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480 # 8 hours timeout
    
    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 1024
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/mnt/build'

    - name: Additional space cleanup and setup
      run: |
        # Remove more unnecessary packages and files
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/.ghcup
        sudo rm -rf /usr/share/swift
        sudo rm -rf /var/lib/gems
        
        # Clean package cache
        sudo apt-get autoclean
        sudo apt-get autoremove -y
        
        # Clear temp files
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        # Setup build directory on the larger mount
        mkdir -p /mnt/build
        sudo chown -R $USER:$USER /mnt/build
        
        # Check available space
        echo "Available space after cleanup:"
        df -h
        
        # Ensure we have enough space (at least 80GB)
        AVAILABLE_GB=$(df /mnt/build | awk 'NR==2 {print int($4/1024/1024)}')
        echo "Available space for build: ${AVAILABLE_GB}GB"
        
        if [ $AVAILABLE_GB -lt 80 ]; then
          echo "‚ùå Insufficient space: ${AVAILABLE_GB}GB available, need at least 80GB"
          echo "üí° Consider reducing build targets or using GitHub's larger runners"
          exit 1
        fi

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git gnupg gperf \
          imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5 libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
          lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python-is-python3 \
          openjdk-8-jdk android-tools-adb android-tools-fastboot \
          xz-utils bc

    - name: Set up environment
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # Install repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # Set up ccache
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 25G

    - name: Initialize LineageOS workspace
      run: |
        # Use the larger mount point for builds
        mkdir -p /mnt/build/lineage-21-pre-qpr2-build-td
        cd /mnt/build/lineage-21-pre-qpr2-build-td
        
        repo init -u https://github.com/LOS21-pre-QPR2/android.git -b lineage-21.0 --git-lfs --depth=1

    - name: Clone build scripts and patches
      run: |
        cd /mnt/build/lineage-21-pre-qpr2-build-td
        git clone https://github.com/AndyCGYan/lineage_build_unified lineage_build_unified -b lineage-21-pre-qpr2-td --depth=1
        git clone https://github.com/AndyCGYan/lineage_patches_unified lineage_patches_unified -b lineage-21-pre-qpr2-td --depth=1

    - name: Sync LineageOS sources
      run: |
        cd /mnt/build/lineage-21-pre-qpr2-build-td
        
        # Use fewer parallel jobs to reduce memory usage
        repo sync -c -j$(( $(nproc --all) / 2 )) --force-sync --no-clone-bundle --no-tags

    - name: Build LineageOS GSI
      run: |
        cd /mnt/build/lineage-21-pre-qpr2-build-td
        
        # Set build targets from input or default
        BUILD_TARGETS="${{ github.event.inputs.build_targets || 'A64VN A64GN 64VN 64GN' }}"
        
        # Monitor disk space during build
        echo "Disk space before build:"
        df -h /mnt/build
        
        # Start the build with memory optimization
        export USE_CCACHE=1
        export CCACHE_DIR=/mnt/build/.ccache
        export JACK_SERVER_VM_ARGUMENTS="-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4g"
        
        bash lineage_build_unified/build_unified.sh treble $BUILD_TARGETS

    - name: Prepare and compress artifacts for upload
      if: always()
      run: |
        cd /mnt/build/lineage-21-pre-qpr2-build-td
        
        # Create upload directories
        mkdir -p ~/upload ~/upload_compressed
        
        # Find and copy built images
        find out/ -name "*.img" -o -name "*.zip" | while read -r file; do
          if [[ -f "$file" ]]; then
            cp "$file" ~/upload/
          fi
        done
        
        # Create build info
        DATE=$(date +"%d-%m-%Y %H:%M")
        BUILD_TARGETS="${{ github.event.inputs.build_targets || 'A64VN A64GN 64VN 64GN' }}"
        BUILD_INFO="LineageOS 21 GSI Build - $DATE
        Targets: $BUILD_TARGETS
        Compression: XZ (LZMA2) Level 6"
        echo "$BUILD_INFO" > ~/upload/build_info.txt
        
        # Compress files with XZ for Telegram upload
        cd ~/upload
        echo "Starting compression of built files..."
        
        for file in *.img *.zip; do
          if [[ -f "$file" ]]; then
            echo "Compressing $file..."
            
            # Get file size before compression
            ORIGINAL_SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
            
            # Compress with XZ (level 6 for good balance of speed vs compression)
            # -T 0 uses all available CPU cores
            xz -6 -T 0 -v "$file"
            COMPRESSED_FILE="${file}.xz"
            
            if [[ -f "$COMPRESSED_FILE" ]]; then
              # Get compressed size
              COMPRESSED_SIZE=$(stat -c%s "$COMPRESSED_FILE" 2>/dev/null || echo "0")
              
              # Calculate compression ratio
              if [[ $ORIGINAL_SIZE -gt 0 ]]; then
                RATIO=$(echo "scale=1; $COMPRESSED_SIZE * 100 / $ORIGINAL_SIZE" | bc -l 2>/dev/null || echo "N/A")
                echo "‚úì $file -> $COMPRESSED_FILE"
                echo "  Original: $(numfmt --to=iec-i --suffix=B $ORIGINAL_SIZE)"
                echo "  Compressed: $(numfmt --to=iec-i --suffix=B $COMPRESSED_SIZE) (${RATIO}%)"
              fi
              
              # Move compressed file to upload directory
              mv "$COMPRESSED_FILE" ~/upload_compressed/
            else
              echo "‚ùå Failed to compress $file"
            fi
          fi
        done
        
        # Also compress the build info
        cp build_info.txt ~/upload_compressed/
        
        echo "Compression completed!"
        echo "Files ready for upload:"
        ls -la ~/upload_compressed/

    - name: Upload to Telegram
      if: ${{ github.event.inputs.upload_to_telegram != 'false' && (env.BOT_TOKEN != '' && env.CHAT_ID != '') }}
      run: |
        cd ~/upload_compressed
        
        DATE=$(date +"%d-%m-%Y %H:%M")
        BUILD_TARGETS="${{ github.event.inputs.build_targets || 'A64VN A64GN 64VN 64GN' }}"
        
        # Count files
        XZ_COUNT=$(find . -name "*.xz" | wc -l)
        
        # Calculate total compressed size
        TOTAL_SIZE=0
        if command -v numfmt >/dev/null 2>&1; then
          for file in *.xz; do
            if [[ -f "$file" ]]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            fi
          done
          TOTAL_SIZE_HUMAN=$(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)
        else
          TOTAL_SIZE_HUMAN="Unknown"
        fi
        
        CAPTION="*LineageOS 21 GSI Build - $DATE*
        \`\`\`
        Targets: $BUILD_TARGETS
        Files: $XZ_COUNT (.xz compressed)
        Total size: $TOTAL_SIZE_HUMAN
        Compression: XZ (LZMA2) Level 6
        Branch: lineage-21-pre-qpr2-td
        \`\`\`
        *Decompress with: xz -d filename.img.xz*
        *Flash decompressed .img via fastboot*"
        
        # Upload each compressed file
        for file in *.xz build_info.txt; do
          if [[ -f "$file" ]]; then
            echo "Uploading $file..."
            
            # Check file size (Telegram limit is 50MB)
            FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
            FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            
            if [[ $FILE_SIZE_MB -gt 50 ]]; then
              echo "‚ö†Ô∏è Warning: $file is ${FILE_SIZE_MB}MB, exceeding Telegram's 50MB limit"
              echo "Consider using higher compression or splitting the file"
              continue
            fi
            
            # Upload to Telegram
            if curl -F document=@"$file" \
                    -F "chat_id=$CHAT_ID" \
                    -F "caption=$CAPTION" \
                    -F "parse_mode=Markdown" \
                    https://api.telegram.org/bot$BOT_TOKEN/sendDocument; then
              echo "‚úÖ Successfully uploaded $file"
            else
              echo "‚ùå Failed to upload $file"
            fi
                 
            # Add delay between uploads to avoid rate limiting
            sleep 5
          fi
        done

    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lineageos-gsi-${{ github.run_number }}
        path: ~/upload/
        retention-days: 7

    - name: Clean up workspace
      if: always()
      run: |
        cd ~
        rm -rf /mnt/build/lineage-21-pre-qpr2-build-td
        ccache -C
